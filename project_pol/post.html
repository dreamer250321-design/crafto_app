<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Custom Post</title>
  <link rel="stylesheet" href="style1.css">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    canvas { border: 1px solid #ccc; margin-top: 20px; }
    .btn { padding: 12px 20px; margin: 10px; border: none; background: red; color: white; font-size: 18px; cursor: pointer; border-radius: 8px; }
    .btn:disabled { background: gray; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Create Your Custom Post</h2>

    <input type="file" id="userPhoto">
    <input type="text" id="userName" placeholder="Enter Your Name">

    <canvas id="postCanvas" width="1200" height="1200"></canvas>

    <center><button class="btn" id="payAndDownload">Pay & Download</button></center>
  </div>

<script>
  const canvas = document.getElementById("postCanvas");
  const ctx = canvas.getContext("2d");

  let uploadedPhoto = null;
  let userName = "";

  const template = new Image();
  template.src = "images/template3.png";
  template.onload = () => drawTemplate();

  function drawTemplate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(template, 0, 0, canvas.width, canvas.height);

    const stripHeight = 120;
    ctx.fillStyle = "red";
    drawRoundedRect(ctx, 0, canvas.height - stripHeight, canvas.width, stripHeight, 60);

    if (uploadedPhoto) {
      const size = 400;
      const x = 800;
      const y = 800;
      ctx.save();
      ctx.beginPath();
      ctx.arc(x + size / 2, y + size / 2, size / 2, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();
      ctx.drawImage(uploadedPhoto, x, y, size, size);
      ctx.restore();
    }

    if (userName) {
      ctx.font = "bold 70px Arial";
      ctx.fillStyle = "white";
      ctx.textAlign = "center";
      ctx.fillText(userName, canvas.width / 2, canvas.height - 40);
    }
  }

  function drawRoundedRect(ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
    ctx.fill();
  }

  document.getElementById("userName").addEventListener("input", function(e) {
    userName = e.target.value;
    drawTemplate();
  });

  document.getElementById("userPhoto").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(evt) {
        uploadedPhoto = new Image();
        uploadedPhoto.onload = () => drawTemplate();
        uploadedPhoto.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    }
  });

  document.getElementById("payAndDownload").addEventListener("click", async function (event) {
    event.preventDefault();

    try {
      const orderRes = await fetch("https://crafto-app-1.onrender.com/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: 50 })
      });

      if (!orderRes.ok) {
        throw new Error("Failed to fetch order. Status: " + orderRes.status);
      }

      const orderData = await orderRes.json();
      console.log("Order Data:", orderData);

      if (!orderData.id) {
        alert("❌ Order ID missing. Check backend response.");
        return;
      }

      const options = {
        key: "rzp_test_RCgYGDZ5Qvvz2p",
        amount: orderData.amount,
        currency: orderData.currency,
        name: "Crafto Posts",
        description: "Download Custom Post",
        order_id: orderData.id,
        prefill: {
          name: userName || "Guest",
          email: "test@example.com",
          contact: "9999999999"
        },
        handler: async function (response) {
          const verifyRes = await fetch("https://crafto-app-1.onrender.com/verify-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(response)
          });

          const verifyData = await verifyRes.json();
          if (verifyData.success) {
            alert("✅ Payment Verified!");
            const link = document.createElement("a");
            link.download = "custom_post.png";
            link.href = canvas.toDataURL();
            link.click();
          } else {
            alert("❌ Payment verification failed!");
          }
        },
        modal: {
          ondismiss: function () {
            console.log("Razorpay popup closed by user.");
          }
        },
        theme: { color: "#F37254" }
      };

      console.log("Razorpay Options:", options);
      const rzp = new Razorpay(options);
      if (rzp) {
        rzp.open();
      } else {
        throw new Error("Razorpay failed to initialize.");
      }

    } catch (err) {
      console.error("Error:", err);
      alert("❌ Something went wrong. Check console for details.");
    }
  });
</script>

</body>
</html>